{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "application_name": {
            "type": "string"
        }
    },
    "variables": {
        "regional_application_name": "[concat(parameters('application_name'), '-', resourceGroup().location)]",
        "sites_api_title_name": "[concat(variables('regional_application_name'), '-title')]",
        "sites_api_person_name": "[concat(variables('regional_application_name'), '-person')]",
        "sites_ui_client_name": "[concat(variables('regional_application_name'), '-ui')]",
        "application_gateway_size": "WAF_Medium",
        "application_gateway_capacity": 2,
        "application_gateway_name": "appGateway",
        "public_ipaddress_name": "publicIp",
        "virtual_network_name": "virtualNetwork",
        "subnet_name": "appGatewaySubnet",
        "subnet_ref": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('virtual_network_name'), variables('subnet_name'))]",
        "public_ipaddress_ref": "[resourceId('Microsoft.Network/publicIPAddresses', variables('public_ipaddress_name'))]",
        "application_gateway_ref": "[resourceId('Microsoft.Network/applicationGateways', variables('application_gateway_name'))]"
    },
    "resources": [
        {
            "apiVersion": "2017-06-01",
            "name": "[variables('application_gateway_name')]",
            "type": "Microsoft.Network/applicationGateways",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[variables('virtual_network_name')]",
                "[variables('public_ipaddress_name')]",
                "[variables('sites_ui_client_name')]",
                "[variables('sites_api_title_name')]",
                "[variables('sites_api_person_name')]"
            ],
            "properties": {
                "sku": {
                    "name": "[variables('application_gateway_size')]",
                    "tier": "WAF",
                    "capacity": "[variables('application_gateway_capacity')]"
                },
                "gatewayIPConfigurations": [
                    {
                        "name": "appGatewayIpConfig",
                        "properties": {
                            "subnet": {
                                "id": "[variables('subnet_ref')]"
                            }
                        }
                    }
                ],
                "frontendIPConfigurations": [
                    {
                        "name": "appGatewayFrontendIP",
                        "properties": {
                            "PublicIPAddress": {
                                "id": "[variables('public_ipaddress_ref')]"
                            }
                        }
                    }
                ],
                "frontendPorts": [
                    {
                        "name": "appGatewayFrontendPort",
                        "properties": {
                            "Port": 80
                        }
                    }
                ],
                "backendAddressPools": [
                    {
                        "name": "uiBackendPool",
                        "properties": {
                            "BackendAddresses": [
                                {
                                    "fqdn": "[concat(variables('sites_ui_client_name'), '.azurewebsites.net')]"
                                }
                            ]
                        }
                    },
                    {
                        "name": "titlesBackendPool",
                        "properties": {
                            "BackendAddresses": [
                                {
                                    "fqdn": "[concat(variables('sites_api_title_name'), '.azurewebsites.net')]"
                                }
                            ]
                        }
                    },
                    {
                        "name": "peopleBackendPool",
                        "properties": {
                            "BackendAddresses": [
                                {
                                    "fqdn": "[concat(variables('sites_api_person_name'), '.azurewebsites.net')]"
                                }
                            ]
                        }
                    }
                ],
                "backendHttpSettingsCollection": [
                    {
                        "name": "frontendHttpSettings",
                        "properties": {
                            "Port": 80,
                            "Protocol": "Http",
                            "CookieBasedAffinity": "Disabled",
                            "PickHostNameFromBackendAddress": true,
                            "ProbeEnabled": true,
                            "Probe": {
                                "id": "[concat(variables('application_gateway_ref'), '/probes/frontendProbe')]"
                            }
                        }
                    },
                    {
                        "name": "backendHttpSettings",
                        "properties": {
                            "Port": 80,
                            "Protocol": "Http",
                            "CookieBasedAffinity": "Disabled",
                            "PickHostNameFromBackendAddress": true,
                            "ProbeEnabled": true,
                            "Probe": {
                                "id": "[concat(variables('application_gateway_ref'), '/probes/backendProbe')]"
                            }
                        }
                    }
                ],
                "httpListeners": [
                    {
                        "name": "appGatewayHttpListener",
                        "properties": {
                            "FrontendIPConfiguration": {
                                "Id": "[concat(variables('application_gateway_ref'), '/frontendIPConfigurations/appGatewayFrontendIP')]"
                            },
                            "FrontendPort": {
                                "Id": "[concat(variables('application_gateway_ref'), '/frontendPorts/appGatewayFrontendPort')]"
                            },
                            "Protocol": "Http",
                            "SslCertificate": null
                        }
                    }
                ],
                "urlPathMaps": [
                    {
                        "name": "pathRuleMap",
                        "properties": {
                            "defaultBackendAddressPool": {
                                "id": "[concat(variables('application_gateway_ref'), '/backendAddressPools/uiBackendPool')]"
                            },
                            "defaultBackendHttpSettings": {
                                "id": "[concat(variables('application_gateway_ref'), '/backendHttpSettingsCollection/frontendHttpSettings')]"
                            },
                            "pathRules": [
                                {
                                    "name": "ui",
                                    "properties": {
                                        "paths": [
                                            "/ui"
                                        ],
                                        "backendAddressPool": {
                                            "id": "[concat(variables('application_gateway_ref'), '/backendAddressPools/uiBackendPool')]"
                                        },
                                        "backendHttpSettings": {
                                            "id": "[concat(variables('application_gateway_ref'), '/backendHttpSettingsCollection/frontendHttpSettings')]"
                                        }
                                    },
                                    "type": "Microsoft.Network/applicationGateways/urlPathMaps/pathRules"
                                },
                                {
                                    "name": "titles",
                                    "properties": {
                                        "paths": [
                                            "/titles"
                                        ],
                                        "backendAddressPool": {
                                            "id": "[concat(variables('application_gateway_ref'), '/backendAddressPools/titlesBackendPool')]"
                                        },
                                        "backendHttpSettings": {
                                            "id": "[concat(variables('application_gateway_ref'), '/backendHttpSettingsCollection/backendHttpSettings')]"
                                        }
                                    },
                                    "type": "Microsoft.Network/applicationGateways/urlPathMaps/pathRules"
                                },
                                {
                                    "name": "people",
                                    "properties": {
                                        "paths": [
                                            "/people"
                                        ],
                                        "backendAddressPool": {
                                            "id": "[concat(variables('application_gateway_ref'), '/backendAddressPools/peopleBackendPool')]"
                                        },
                                        "backendHttpSettings": {
                                            "id": "[concat(variables('application_gateway_ref'), '/backendHttpSettingsCollection/backendHttpSettings')]"
                                        }
                                    },
                                    "type": "Microsoft.Network/applicationGateways/urlPathMaps/pathRules"
                                }
                            ]
                        },
                        "type": "Microsoft.Network/applicationGateways/urlPathMaps"
                    }
                ],
                "requestRoutingRules": [
                    {
                        "Name": "pathRule",
                        "properties": {
                            "RuleType": "PathBasedRouting",
                            "httpListener": {
                                "id": "[concat(variables('application_gateway_ref'), '/httpListeners/appGatewayHttpListener')]"
                            },
                            "urlPathMap": {
                                "id": "[concat(variables('application_gateway_ref'), '/urlPathMaps/pathRuleMap')]"
                            }
                        }
                    }
                ],
                "probes": [
                    {
                        "Name": "frontendProbe",
                        "properties": {
                            "protocol": "Http",
                            "path": "/",
                            "interval": 30,
                            "timeout": 10,
                            "unhealthyThreshold": 3,
                            "minServers": 0,
                            "pickHostNameFromBackendHttpSettings": true,
                            "match": {
                                "body": "",
                                "statusCodes": [
                                    "200"
                                ]
                            }
                        }
                    },
                    {
                        "Name": "backendProbe",
                        "properties": {
                            "protocol": "Http",
                            "path": "/health",
                            "interval": 30,
                            "timeout": 10,
                            "unhealthyThreshold": 3,
                            "minServers": 0,
                            "pickHostNameFromBackendHttpSettings": true,
                            "match": {
                                "body": "",
                                "statusCodes": [
                                    "200"
                                ]
                            }
                        }
                    }
                ]
            }
        }
    ],
    "outputs": {}
}